(function(a,b){if(typeof define=='function'&&define.amd)define(['leaflet','iso8601-js-period'],a);else if(typeof exports=='object')module.exports=a(require('leaflet'),require('iso8601-js-period'));else if(typeof b!='undefined'&&b.L&&typeof L!='undefined'){var c=nezasa.iso8601;b.L.TimeDimension=a(L,c)}})(function(a,c){if(typeof b=='undefined')var b={iso8601:c};return a.TimeDimension=(a.Layer||a.Class).extend({includes:a.Evented||a.Mixin.Events,initialize:function(b){a.setOptions(this,b),this._availableTimes=this._generateAvailableTimes(),this._currentTimeIndex=-1,this._loadingTimeIndex=-1,this._loadingTimeout=this.options.loadingTimeout||3e3,this._syncedLayers=[],this._aggregateTimes=this.options.aggregateTimes,this._availableTimes.length>0&&this.setCurrentTime(this.options.currentTime||this._getDefaultCurrentTime()),this.options.lowerLimitTime&&this.setLowerLimit(this.options.lowerLimitTime),this.options.upperLimitTime&&this.setUpperLimit(this.options.upperLimitTime)},setAggregateTime:function(a){this._aggregateTimes=a},getAggregateTime:function(){return this._aggregateTimes},getAvailableTimes:function(){return this._availableTimes},getCurrentTimeIndex:function(){return this._currentTimeIndex===-1?this._availableTimes.length?0:-1:this._currentTimeIndex},getCurrentTime:function(){var a=-1;return this._loadingTimeIndex!==-1?a=this._loadingTimeIndex:a=this.getCurrentTimeIndex(),a>=0?this._availableTimes[a]:null},isLoading:function(){return this._loadingTimeIndex!==-1},setCurrentTimeIndex:function(a){var b=this._upperLimit||this._availableTimes.length-1,c=this._lowerLimit||0,d;if(a=Math.min(Math.max(c,a),b),a<0)return;this._loadingTimeIndex=a,d=this._availableTimes[a],this._checkSyncedLayersReady(this._availableTimes[this._loadingTimeIndex])?this._newTimeIndexLoaded():(this.fire('timeloading',{time:d}),setTimeout(function(a){a==this._loadingTimeIndex&&this._newTimeIndexLoaded()}.bind(this,a),this._loadingTimeout))},_newTimeIndexLoaded:function(){if(this._loadingTimeIndex===-1)return;var a=this._availableTimes[this._loadingTimeIndex];this._currentTimeIndex=this._loadingTimeIndex,this.fire('timeload',{time:a,aggregateTimes:this._aggregateTimes}),this._loadingTimeIndex=-1},_checkSyncedLayersReady:function(b){for(var a=0,c=this._syncedLayers.length;a<c;a++)if(this._syncedLayers[a].isReady)if(!this._syncedLayers[a].isReady(b))return!1;return!0},setCurrentTime:function(a){var b=this._seekNearestTimeIndex(a);this.setCurrentTimeIndex(b)},seekNearestTime:function(a){var b=this._seekNearestTimeIndex(a);return this._availableTimes[b]},nextTime:function(d,e){var a,b,c;d||(d=1),a=this._currentTimeIndex,b=this._upperLimit||this._availableTimes.length-1,c=this._lowerLimit||0,this._loadingTimeIndex>-1&&(a=this._loadingTimeIndex),a=a+d,a>b&&(e?a=c:a=b),a<c&&(e?a=b:a=c),this.setCurrentTimeIndex(a)},prepareNextTimes:function(c,i,j){var a,g,b,h,d,e,f;c||(c=1),a=this._currentTimeIndex,g=a,this._loadingTimeIndex>-1&&(a=this._loadingTimeIndex);for(b=0,h=this._syncedLayers.length;b<h;b++)this._syncedLayers[b].setMinimumForwardCache&&this._syncedLayers[b].setMinimumForwardCache(i);for(d=i,e=this._upperLimit||this._availableTimes.length-1,f=this._lowerLimit||0;d>0;){if(a=a+c,a>e)if(j)a=f;else break;if(a<f)if(j)a=e;else break;if(g===a)break;this.fire('timeloading',{time:this._availableTimes[a]}),d--}},getNumberNextTimesReady:function(d,e,h){var a,b,c,f,g,i;for(d||(d=1),a=this._currentTimeIndex,this._loadingTimeIndex>-1&&(a=this._loadingTimeIndex),b=e,c=0,f=this._upperLimit||this._availableTimes.length-1,g=this._lowerLimit||0;b>0;){if(a=a+d,a>f)if(h)a=g;else{b=0,c=e;break}if(a<g)if(h)a=f;else{b=0,c=e;break}i=this._availableTimes[a],this._checkSyncedLayersReady(i)&&c++,b--}return c},previousTime:function(a,b){this.nextTime(a*-1,b)},registerSyncedLayer:function(a){this._syncedLayers.push(a),a.on('timeload',this._onSyncedLayerLoaded,this)},unregisterSyncedLayer:function(a){var b=this._syncedLayers.indexOf(a);b!=-1&&this._syncedLayers.splice(b,1),a.off('timeload',this._onSyncedLayerLoaded,this)},_onSyncedLayerLoaded:function(a){a.time==this._availableTimes[this._loadingTimeIndex]&&this._checkSyncedLayersReady(a.time)&&(this._aggregateTimes&&this._currentTimeIndex<0&&this.fire('startaggregation',{aggregateTimes:this._aggregateTimes}),this._newTimeIndexLoaded())},_generateAvailableTimes:function(){var b,c,d;return this.options.times?a.TimeDimension.Util.parseTimesExpression(this.options.times):this.options.timeInterval?(b=a.TimeDimension.Util.parseTimeInterval(this.options.timeInterval),c=this.options.period||'P1D',d=this.options.validTimeRange||void 0,a.TimeDimension.Util.explodeTimeRange(b[0],b[1],c,d)):[]},_getDefaultCurrentTime:function(){var a=(new Date).getTime(),b;return this._availableTimes.length&&(a=this._availableTimes[0]),b=this._seekNearestTimeIndex(a),this._availableTimes[b]},_seekNearestTimeIndex:function(b){var a=0,c;if(isNaN(b))return a;for(c=this._availableTimes.length;a<c;a++)if(b<this._availableTimes[a])break;return a>0&&a--,a},setAvailableTimes:function(c,b){var e=this.getCurrentTime(),f=this.getLowerLimit(),g=this.getUpperLimit(),h,d;if(b=='extremes')h=this.options.period||'P1D',this._availableTimes=a.TimeDimension.Util.explodeTimeRange(new Date(c[0]),new Date(c[c.length-1]),h);else if(d=a.TimeDimension.Util.parseTimesExpression(c),this._availableTimes.length===0)this._availableTimes=d;else if(b=='intersect')this._availableTimes=a.TimeDimension.Util.intersect_arrays(d,this._availableTimes);else if(b=='union')this._availableTimes=a.TimeDimension.Util.union_arrays(d,this._availableTimes);else if(b=='replace')this._availableTimes=d;else throw'Merge available times mode not implemented: '+b;f&&this.setLowerLimit(f),g&&this.setUpperLimit(g),this.setCurrentTime(e),this.fire('availabletimeschanged',{availableTimes:this._availableTimes,currentTime:e})},getLowerLimit:function(){return this._availableTimes[this.getLowerLimitIndex()]},getUpperLimit:function(){return this._availableTimes[this.getUpperLimitIndex()]},setLowerLimit:function(a){var b=this._seekNearestTimeIndex(a);this.setLowerLimitIndex(b)},setUpperLimit:function(a){var b=this._seekNearestTimeIndex(a);this.setUpperLimitIndex(b)},setLowerLimitIndex:function(a){this._lowerLimit=Math.min(Math.max(a||0,0),this._upperLimit||this._availableTimes.length-1),this.fire('limitschanged',{lowerLimit:this._lowerLimit,upperLimit:this._upperLimit})},setUpperLimitIndex:function(a){this._upperLimit=Math.max(Math.min(a,this._availableTimes.length-1),this._lowerLimit||0),this.fire('limitschanged',{lowerLimit:this._lowerLimit,upperLimit:this._upperLimit})},getLowerLimitIndex:function(){return this._lowerLimit},getUpperLimitIndex:function(){return this._upperLimit}}),a.Map.addInitHook(function(){this.options.timeDimension&&(this.timeDimension=a.timeDimension(this.options.timeDimensionOptions||{}))}),a.timeDimension=function(b){return new a.TimeDimension(b)},a.TimeDimension.Util={getTimeDuration:function(a){if(typeof b=='undefined')throw"iso8601-js-period library is required for Leatlet.TimeDimension: https://github.com/nezasa/iso8601-js-period";return b.iso8601.Period.parse(a,!0)},addTimeDuration:function(b,a,f){var c,d,e;typeof f=='undefined'&&(f=!0),(typeof a=='string'||a instanceof String)&&(a=this.getTimeDuration(a)),c=a.length,d=f?"getUTC":"get",e=f?"setUTC":"set",c>0&&a[0]!=0&&b[e+"FullYear"](b[d+"FullYear"]()+a[0]),c>1&&a[1]!=0&&b[e+"Month"](b[d+"Month"]()+a[1]),c>2&&a[2]!=0&&b[e+"Date"](b[d+"Date"]()+a[2]*7),c>3&&a[3]!=0&&b[e+"Date"](b[d+"Date"]()+a[3]),c>4&&a[4]!=0&&b[e+"Hours"](b[d+"Hours"]()+a[4]),c>5&&a[5]!=0&&b[e+"Minutes"](b[d+"Minutes"]()+a[5]),c>6&&a[6]!=0&&b[e+"Seconds"](b[d+"Seconds"]()+a[6])},subtractTimeDuration:function(e,a,f){var c,b,d;(typeof a=='string'||a instanceof String)&&(a=this.getTimeDuration(a)),c=[];for(b=0,d=a.length;b<d;b++)c.push(-a[b]);this.addTimeDuration(e,c,f)},parseAndExplodeTimeRange:function(b){var a=b.split('/'),c=new Date(Date.parse(a[0])),d=new Date(Date.parse(a[1])),e=a.length>2?a[2]:"P1D";return this.explodeTimeRange(c,d,e)},explodeTimeRange:function(j,c,k,d){var l=this.getTimeDuration(k),g=[],a=new Date(j.getTime()),e=null,h=null,f=null,i=null,b;for(d!==void 0&&(b=d.split('/'),e=b[0].split(':')[0],h=b[0].split(':')[1],f=b[1].split(':')[0],i=b[1].split(':')[1]);a<c;)(d===void 0||a.getUTCHours()>=e&&a.getUTCHours()<=f)&&(a.getUTCHours()!=e||a.getUTCMinutes()>=h)&&(a.getUTCHours()!=f||a.getUTCMinutes()<=i)&&g.push(a.getTime()),this.addTimeDuration(a,l);return a>=c&&g.push(c.getTime()),g},parseTimeInterval:function(e){var c=e.split("/"),b,a,d;if(c.length!=2)throw"Incorrect ISO9601 TimeInterval: "+e;return b=Date.parse(c[0]),a=null,d=null,isNaN(b)?(d=this.getTimeDuration(c[0]),a=Date.parse(c[1]),b=new Date(a),this.subtractTimeDuration(b,d,!0),a=new Date(a)):(a=Date.parse(c[1]),isNaN(a)?(d=this.getTimeDuration(c[1]),a=new Date(b),this.addTimeDuration(a,d,!0)):a=new Date(a),b=new Date(b)),[b,a]},parseTimesExpression:function(b){var a=[],f,c,d,e,g;if(!b)return a;if(typeof b=='string'||b instanceof String){{f=b.split(",");for(e=0,g=f.length;e<g;e++)c=f[e],c.split("/").length==3?a=a.concat(this.parseAndExplodeTimeRange(c)):(d=Date.parse(c),isNaN(d)||a.push(d))}}else a=b;return a.sort(function(a,b){return a-b})},intersect_arrays:function(d,e){for(var a=d.slice(0),b=e.slice(0),c=[];a.length>0&&b.length>0;)a[0]<b[0]?a.shift():a[0]>b[0]?b.shift():(c.push(a.shift()),b.shift());return c},union_arrays:function(d,e){for(var b=d.slice(0),c=e.slice(0),a=[];b.length>0&&c.length>0;)b[0]<c[0]?a.push(b.shift()):b[0]>c[0]?a.push(c.shift()):(a.push(b.shift()),c.shift());return b.length>0?a=a.concat(b):c.length>0&&(a=a.concat(c)),a},sort_and_deduplicate:function(a){var c,d,b,e;a=a.slice(0).sort(),c=[],d=null;for(b=0,e=a.length;b<e;b++)a[b]!==d&&(c.push(a[b]),d=a[b]);return c}},a.TimeDimension.Layer=(a.Layer||a.Class).extend({includes:a.Evented||a.Mixin.Events,options:{opacity:1,zIndex:1},initialize:function(b,c){a.setOptions(this,c||{}),this._map=null,this._baseLayer=b,this._currentLayer=null,this._timeDimension=this.options.timeDimension||null},addTo:function(a){return a.addLayer(this),this},onAdd:function(a){this._map=a,!this._timeDimension&&a.timeDimension&&(this._timeDimension=a.timeDimension),this._timeDimension.on("timeloading",this._onNewTimeLoading,this),this._timeDimension.on("timeload",this._update,this),this._timeDimension.on("startaggregation",this._startAggregationTimeDimension,this),this._timeDimension.registerSyncedLayer(this),this._update()},onRemove:function(a){this._timeDimension.unregisterSyncedLayer(this),this._timeDimension.off("timeloading",this._onNewTimeLoading,this),this._timeDimension.off("timeload",this._update,this),this._timeDimension.off("startaggregation",this._startAggregationTimeDimension,this),this.eachLayer(a.removeLayer,a),this._map=null},eachLayer:function(a,b){return a.call(b,this._baseLayer),this},setZIndex:function(a){return this.options.zIndex=a,this._baseLayer.setZIndex&&this._baseLayer.setZIndex(a),this._currentLayer&&this._currentLayer.setZIndex&&this._currentLayer.setZIndex(a),this},setOpacity:function(a){return this.options.opacity=a,this._baseLayer.setOpacity&&this._baseLayer.setOpacity(a),this._currentLayer&&this._currentLayer.setOpacity&&this._currentLayer.setOpacity(a),this},bringToBack:function(){if(!this._currentLayer)return;return this._currentLayer.bringToBack(),this},bringToFront:function(){if(!this._currentLayer)return;return this._currentLayer.bringToFront(),this},_startAggregationTimeDimension:function(a){this._baseLayer._visible=!1,this._baseLayer.redraw()},_onNewTimeLoading:function(a){this.fire('timeload',{time:a.time})},isReady:function(a){return!0},_update:function(){return!0},getBaseLayer:function(){return this._baseLayer},getBounds:function(){var b=new a.LatLngBounds;return this._currentLayer&&b.extend(this._currentLayer.getBounds?this._currentLayer.getBounds():this._currentLayer.getLatLng()),b}}),a.timeDimension.layer=function(b,c){return new a.TimeDimension.Layer(b,c)},a.TimeDimension.Layer.WMS=a.TimeDimension.Layer.extend({initialize:function(b,c){a.TimeDimension.Layer.prototype.initialize.call(this,b,c),this._timeCacheBackward=this.options.cacheBackward||this.options.cache||0,this._timeCacheForward=this.options.cacheForward||this.options.cache||0,this._wmsVersion=this.options.wmsVersion||this.options.version||b.options.version||"1.1.1",this._getCapabilitiesParams=this.options.getCapabilitiesParams||{},this._getCapabilitiesAlternateUrl=this.options.getCapabilitiesUrl||null,this._getCapabilitiesAlternateLayerName=this.options.getCapabilitiesLayerName||null,this._proxy=this.options.proxy||null,this._updateTimeDimension=this.options.updateTimeDimension||!1,this._setDefaultTime=this.options.setDefaultTime||!1,this._updateTimeDimensionMode=this.options.updateTimeDimensionMode||'intersect',this._layers={},this._defaultTime=0,this._availableTimes=[],this._capabilitiesRequested=!1,(this._updateTimeDimension||this.options.requestTimeFromCapabilities)&&this._requestTimeDimensionFromCapabilities(),this._baseLayer.on('load',function(){this._baseLayer.setLoaded(!0),this.fire('timeload',{time:this._defaultTime,aggregateTimes:c.timeDimension._aggregateTimes})}.bind(this))},getEvents:function(){var b=a.bind(this._unvalidateCache,this);return{moveend:b,zoomend:b}},eachLayer:function(b,c){for(var d in this._layers)this._layers.hasOwnProperty(d)&&b.call(c,this._layers[d]);return a.TimeDimension.Layer.prototype.eachLayer.call(this,b,c)},_onNewTimeLoading:function(b){var a=this._getLayerForTime(b.time);this._map.hasLayer(a)||this._map.addLayer(a)},isReady:function(a){var b=this._getLayerForTime(a);if(this.options.bounds&&this._map)if(!this._map.getBounds().contains(this.options.bounds))return!0;return b.isLoaded()},onAdd:function(b){a.TimeDimension.Layer.prototype.onAdd.call(this,b),this._availableTimes.length==0?this._requestTimeDimensionFromCapabilities():this._updateTimeDimensionAvailableTimes()},_update:function(c){var b,a,d;if(!this._map)return;b=this._timeDimension.getCurrentTime(),a=this._getLayerForTime(b),this._currentLayer==null&&(this._currentLayer=a),this._map.hasLayer(a)?(d=c.aggregateTimes?c.aggregateTimes:!1,this._showLayer(a,b,d)):this._map.addLayer(a)},setOpacity:function(c){a.TimeDimension.Layer.prototype.setOpacity.apply(this,arguments);for(var b in this._layers)this._layers.hasOwnProperty(b)&&this._layers[b].setOpacity&&this._layers[b].setOpacity(c)},setZIndex:function(c){a.TimeDimension.Layer.prototype.setZIndex.apply(this,arguments);for(var b in this._layers)this._layers.hasOwnProperty(b)&&this._layers[b].setZIndex&&this._layers[b].setZIndex(c)},setParams:function(c,d){a.extend(this._baseLayer.options,c),this._baseLayer.setParams&&this._baseLayer.setParams(c,d);for(var b in this._layers)this._layers.hasOwnProperty(b)&&this._layers[b].setParams&&(this._layers[b].setLoaded(!1),this._layers[b].setParams(c,d));return this},_unvalidateCache:function(){var b=this._timeDimension.getCurrentTime(),a;for(a in this._layers)b!=a&&this._layers.hasOwnProperty(a)&&(this._layers[a].setLoaded(!1),this._layers[a].redraw())},_evictCachedTimes:function(b,g,f){var c=this._getLoadedTimes(),h=String(this._currentTime),e=c.indexOf(h),d=[],a;g>-1&&!f&&(a=e-g,a>0&&(d=c.splice(0,a),this._removeLayers(d))),b>-1&&(f&&(b=0),a=c.length-e-b-1,a>0&&(d=c.splice(e+b+1,a),this._removeLayers(d)))},_showLayer:function(a,c,d){if(this._currentLayer&&this._currentLayer!==a){var e=this._availableTimes.indexOf(this._currentTime),b=this._availableTimes.indexOf(c);d?Math.abs(e-b)>1?this._evaluateCachedLayers(b):e>b&&this._currentLayer.hide():this._currentLayer.hide()}if(a.show(),this._currentLayer&&this._currentLayer===a)return;this._currentLayer=a,this._currentTime=c,this._evictCachedTimes(this._timeCacheForward,this._timeCacheBackward,d)},_evaluateCachedLayers:function(d){for(var c=0,e=this._availableTimes.length,a,b;c<e;c++)a=this._availableTimes[c],c>d?this._layers[a]&&(this._layers[a].hide(),this._layers[a].redraw()):this._layers[a]?(this._layers[a].show(),this._layers[a].setLoaded(!1),this._layers[a].redraw()):(b=this._createLayerForTime(a),this._layers[a]=b,this._map&&!this._map.hasLayer(b)&&this._map.addLayer(b),b.on('load',function(a){a.setLoaded(!0)}.bind(this,b)))},_getLayerForTime:function(a){var c,b;return a==0||a==this._defaultTime||a==null?this._baseLayer:this._layers.hasOwnProperty(a)?this._layers[a]:(c=this._getNearestTime(a),this._layers.hasOwnProperty(c))?this._layers[c]:(b=this._createLayerForTime(c),this._layers[a]=b,b.on('load',function(b,a){b.setLoaded(!0),this._layers[a]||(this._layers[a]=b),this._timeDimension&&a==this._timeDimension.getCurrentTime()&&!this._timeDimension.isLoading()&&this._showLayer(b,a),this.fire('timeload',{time:a})}.bind(this,b,a)),b.onAdd=function(a){Object.getPrototypeOf(this).onAdd.call(this,a),this.hide()}.bind(b),b)},_createLayerForTime:function(b){var a=this._baseLayer.options;return a.time=new Date(b).toISOString(),new this._baseLayer.constructor(this._baseLayer.getURL(),a,this._baseLayer.headers,this._baseLayer.abort)},_getLoadedTimes:function(){var a=[],b;for(b in this._layers)this._layers.hasOwnProperty(b)&&a.push(b);return a.sort(function(a,b){return a-b})},_removeLayers:function(b){for(var a=0,c=b.length;a<c;a++)this._map&&this._map.removeLayer(this._layers[b[a]]),delete this._layers[b[a]]},setMinimumForwardCache:function(a){a>this._timeCacheForward&&(this._timeCacheForward=a)},_requestTimeDimensionFromCapabilities:function(){var b,a;if(this._capabilitiesRequested)return;if(this._capabilitiesRequested=!0,b=this._getCapabilitiesUrl(),this._proxy&&(b=this._proxy+'?url='+encodeURIComponent(b)),a=new XMLHttpRequest,a.addEventListener("load",function(b){var a=b.currentTarget.responseXML;this._defaultTime=Date.parse(this._getDefaultTimeFromCapabilities(a)),this._setDefaultTime=this._setDefaultTime||this._timeDimension&&this._timeDimension.getAvailableTimes().length==0,this.setAvailableTimes(this._parseTimeDimensionFromCapabilities(a)),this._setDefaultTime&&this._timeDimension&&this._timeDimension.setCurrentTime(this._defaultTime)}.bind(this)),a.overrideMimeType('application/xml'),a.open("GET",b),this._baseLayer.headers)for(let b=0;b<this._baseLayer.headers.length;b++){const c=this._baseLayer.headers[b];a.setRequestHeader(c.header,c.value)}a.send()},_getCapabilitiesUrl:function(){var b=this._baseLayer.getURL(),c;return this._getCapabilitiesAlternateUrl&&(b=this._getCapabilitiesAlternateUrl),c=a.extend({},this._getCapabilitiesParams,{request:'GetCapabilities',service:'WMS',version:this._wmsVersion}),b=b+a.Util.getParamString(c,b,c.uppercase),b},_parseTimeDimensionFromCapabilities:function(c){var d=c.querySelectorAll('Layer[queryable="1"]'),e=this._getCapabilitiesAlternateLayerName?this._getCapabilitiesAlternateLayerName:this._baseLayer.wmsParams.layers,a=null,b=null;return d.forEach(function(b){b.querySelector("Name").innerHTML===e&&(a=b)}),a&&(b=this._getTimesFromLayerCapabilities(a),b||(b=this._getTimesFromLayerCapabilities(a.parentNode))),b},_getTimesFromLayerCapabilities:function(d){var c=null,a=d.querySelectorAll("Dimension[name='time']"),b;return a&&a.length&&a[0].textContent.length?c=a[0].textContent.trim():(b=d.querySelectorAll("Extent[name='time']"),b&&b.length&&b[0].textContent.length&&(c=b[0].textContent.trim())),c},_getDefaultTimeFromCapabilities:function(c){var d=c.querySelectorAll('Layer[queryable="1"]'),e=this._getCapabilitiesAlternateLayerName?this._getCapabilitiesAlternateLayerName:this._baseLayer.wmsParams.layers,a=null,b;return d.forEach(function(b){b.querySelector("Name").innerHTML===e&&(a=b)}),b=0,a&&(b=this._getDefaultTimeFromLayerCapabilities(a),b==0&&(b=this._getDefaultTimeFromLayerCapabilities(a.parentNode))),b},_getDefaultTimeFromLayerCapabilities:function(d){var c=0,a=d.querySelectorAll("Dimension[name='time']"),b;return a&&a.length&&a[0].attributes.default?c=a[0].attributes.default.textContent.trim():(b=d.querySelectorAll("Extent[name='time']"),b&&b.length&&b[0].attributes.default&&(c=b[0].attributes.default.textContent.trim())),c},setAvailableTimes:function(b){this._availableTimes=a.TimeDimension.Util.parseTimesExpression(b),this._updateTimeDimensionAvailableTimes()},_updateTimeDimensionAvailableTimes:function(){(this._timeDimension&&this._updateTimeDimension||this._timeDimension&&this._timeDimension.getAvailableTimes().length==0)&&(this._timeDimension.setAvailableTimes(this._availableTimes,this._updateTimeDimensionMode),this._setDefaultTime&&this._defaultTime>0&&this._timeDimension.setCurrentTime(this._defaultTime))},_getNearestTime:function(b){var a,c;if(this._layers.hasOwnProperty(b))return b;if(this._availableTimes.length==0)return b;for(a=0,c=this._availableTimes.length;a<c;a++)if(b<this._availableTimes[a])break;return a>0&&a--,b!=this._availableTimes[a],this._availableTimes[a]}}),a.NonTiledLayer||(a.NonTiledLayer=(a.Layer||a.Class).extend({})),a.NonTiledLayer.include({_visible:!0,_loaded:!1,_originalUpdate:a.NonTiledLayer.prototype._update,_originalOnRemove:a.NonTiledLayer.prototype.onRemove,_update:function(){if(!this._visible&&this._loaded)return;this._originalUpdate()},onRemove:function(a){this._loaded=!1,this._originalOnRemove(a)},setLoaded:function(a){this._loaded=a},isLoaded:function(){return this._loaded},hide:function(){this._visible=!1,this._div.style.display='none'},show:function(){this._visible=!0,this._div.style.display='block'},getURL:function(){return this._wmsUrl}}),a.TileLayer.include({_visible:!0,_loaded:!1,_originalUpdate:a.TileLayer.prototype._update,_update:function(){if(!this._visible&&this._loaded)return;this._originalUpdate()},setLoaded:function(a){this._loaded=a},isLoaded:function(){return this._loaded},hide:function(){this._visible=!1,this._container&&(this._container.style.display='none')},show:function(){this._visible=!0,this._container&&(this._container.style.display='block')},getURL:function(){return this._url}}),a.timeDimension.layer.wms=function(b,c){return new a.TimeDimension.Layer.WMS(b,c)},a.TimeDimension.Layer.GeoJson=a.TimeDimension.Layer.extend({initialize:function(b,c){a.TimeDimension.Layer.prototype.initialize.call(this,b,c),this._updateTimeDimension=this.options.updateTimeDimension||!1,this._updateTimeDimensionMode=this.options.updateTimeDimensionMode||'extremes',this._duration=this.options.duration||null,this._addlastPoint=this.options.addlastPoint||!1,this._waitForReady=this.options.waitForReady||!1,this._defaultTime=0,this._availableTimes=[],this._loaded=!1,this._baseLayer.getLayers().length==0?this._waitForReady?this._baseLayer.on("ready",this._onReadyBaseLayer,this):this._loaded=!0:(this._loaded=!0,this._setAvailableTimes()),this._baseLayer.on('layeradd',function(){this._loaded&&this._setAvailableTimes()}.bind(this))},onAdd:function(b){a.TimeDimension.Layer.prototype.onAdd.call(this,b),this._loaded&&this._setAvailableTimes()},eachLayer:function(b,c){return this._currentLayer&&b.call(c,this._currentLayer),a.TimeDimension.Layer.prototype.eachLayer.call(this,b,c)},isReady:function(a){return this._loaded},_update:function(){var k,e,h,f,c,g,d,j,b,i;if(!this._map)return;if(!this._loaded)return;k=this._timeDimension.getCurrentTime(),e=this._timeDimension.getCurrentTime(),h=0,this._duration&&(f=new Date(e),a.TimeDimension.Util.subtractTimeDuration(f,this._duration,!0),h=f.getTime()),c=a.geoJson(null,this._baseLayer.options),g=this._baseLayer.getLayers();for(d=0,j=g.length;d<j;d++)b=this._getFeatureBetweenDates(g[d].feature,h,e),b&&(c.addData(b),this._addlastPoint&&b.geometry.type=="LineString"&&b.geometry.coordinates.length>0&&(i=b.properties,i.last=!0,c.addData({type:'Feature',properties:i,geometry:{type:'Point',coordinates:b.geometry.coordinates[b.geometry.coordinates.length-1]}})));this._currentLayer&&this._map.removeLayer(this._currentLayer),c.getLayers().length&&(c.addTo(this._map),this._currentLayer=c)},_setAvailableTimes:function(){for(var e=[],c=this._baseLayer.getLayers(),b=0,g=c.length,f,d,h;b<g;b++)if(c[b].feature){f=this._getFeatureTimes(c[b].feature);for(d=0,h=f.length;d<h;d++)e.push(f[d])}this._availableTimes=a.TimeDimension.Util.sort_and_deduplicate(e),this._timeDimension&&(this._updateTimeDimension||this._timeDimension.getAvailableTimes().length==0)&&this._timeDimension.setAvailableTimes(this._availableTimes,this._updateTimeDimensionMode)},_getFeatureTimes:function(a){var c,d,b;if(!a.featureTimes){a.properties?a.properties.hasOwnProperty('coordTimes')?a.featureTimes=a.properties.coordTimes:a.properties.hasOwnProperty('times')?a.featureTimes=a.properties.times:a.properties.hasOwnProperty('linestringTimestamps')?a.featureTimes=a.properties.linestringTimestamps:a.properties.hasOwnProperty('time')?a.featureTimes=[a.properties.time]:a.featureTimes=[]:a.featureTimes=[];for(c=0,d=a.featureTimes.length;c<d;c++)b=a.featureTimes[c],(typeof b=='string'||b instanceof String)&&(b=Date.parse(b.trim()),a.featureTimes[c]=b)}return a.featureTimes},_getFeatureBetweenDates:function(a,h,i){var b=this._getFeatureTimes(a),d,e,f,c,g;if(b.length==0)return a;if(d=null,e=null,f=b.length,b[0]>i||b[f-1]<h)return null;if(b[f-1]>h)for(c=0;c<f;c++)if(d===null&&b[c]>h&&(d=c),b[c]>i){e=c;break}return d===null&&(d=0),e===null&&(e=f),g=[],a.geometry.coordinates[0].length?g=a.geometry.coordinates.slice(d,e):g=a.geometry.coordinates,{type:'Feature',properties:a.properties,geometry:{type:a.geometry.type,coordinates:g}}},_onReadyBaseLayer:function(){this._loaded=!0,this._setAvailableTimes(),this._update()}}),a.timeDimension.layer.geoJson=function(b,c){return new a.TimeDimension.Layer.GeoJson(b,c)},a.TimeDimension.Player=(a.Layer||a.Class).extend({includes:a.Evented||a.Mixin.Events,initialize:function(b,c){a.setOptions(this,b),this._timeDimension=c,this._paused=!1,this._buffer=this.options.buffer||5,this._minBufferReady=this.options.minBufferReady||1,this._waitingForBuffer=!1,this._loop=this.options.loop||!1,this._steps=1,this._timeDimension.on('timeload',function(a){this.release(),this._waitingForBuffer=!1}.bind(this)),this.setTransitionTime(this.options.transitionTime||1e3),this._timeDimension.on('limitschanged availabletimeschanged timeload',function(a){this._timeDimension.prepareNextTimes(this._steps,this._minBufferReady,this._loop)}.bind(this))},_tick:function(){var c=this._getMaxIndex(),d=this._timeDimension.getCurrentTimeIndex()>=c&&this._steps>0,e=this._timeDimension.getCurrentTimeIndex()==0&&this._steps<0,b,a;if(d||e)if(!this._loop){this.pause(),this.stop(),this.fire('animationfinished');return}if(this._paused)return;if(b=0,a=this._bufferSize,this._minBufferReady>0)if(b=this._timeDimension.getNumberNextTimesReady(this._steps,a,this._loop),this._waitingForBuffer){if(b<a){this.fire('waiting',{buffer:a,available:b});return}this.fire('running'),this._waitingForBuffer=!1}else if(b<this._minBufferReady){this._waitingForBuffer=!0,this._timeDimension.prepareNextTimes(this._steps,a,this._loop),this.fire('waiting',{buffer:a,available:b});return}this.pause(),this._timeDimension.nextTime(this._steps,this._loop),a>0&&this._timeDimension.prepareNextTimes(this._steps,a,this._loop)},_getMaxIndex:function(){return Math.min(this._timeDimension.getAvailableTimes().length-1,this._timeDimension.getUpperLimitIndex()||1/0)},start:function(b){if(this._intervalID)return;this._steps=b||1,this._waitingForBuffer=!1,this.options.startOver&&this._timeDimension.getCurrentTimeIndex()===this._getMaxIndex()&&this._timeDimension.setCurrentTimeIndex(this._timeDimension.getLowerLimitIndex()||0),this.release(),this._intervalID=window.setInterval(a.bind(this._tick,this),this._transitionTime),this._tick(),this.fire('play'),this.fire('running')},stop:function(){if(!this._intervalID)return;clearInterval(this._intervalID),this._intervalID=null,this._waitingForBuffer=!1,this.fire('stop')},pause:function(){this._paused=!0},release:function(){this._paused=!1},getTransitionTime:function(){return this._transitionTime},isPlaying:function(){return!!this._intervalID},isWaiting:function(){return this._waitingForBuffer},isLooped:function(){return this._loop},setLooped:function(a){this._loop=a,this.fire('loopchange',{loop:a})},setTransitionTime:function(a){this._transitionTime=a,typeof this._buffer=='function'?this._bufferSize=this._buffer.call(this,this._transitionTime,this._minBufferReady,this._loop):this._bufferSize=this._buffer,this._intervalID&&(this.stop(),this.start(this._steps)),this.fire('speedchange',{transitionTime:a,buffer:this._bufferSize})},getSteps:function(){return this._steps}}),a.UI=a.ui=a.UI||{},a.UI.Knob=a.Draggable.extend({options:{className:'knob',step:1,rangeMin:0,rangeMax:10},initialize:function(b,c){a.setOptions(this,c),this._element=a.DomUtil.create('div',this.options.className||'knob',b),a.Draggable.prototype.initialize.call(this,this._element,this._element),this._container=b,this.on('predrag',function(){this._newPos.y=0,this._newPos.x=this._adjustX(this._newPos.x)},this),this.on('dragstart',function(){a.DomUtil.addClass(b,'dragging')}),this.on('dragend',function(){a.DomUtil.removeClass(b,'dragging')}),a.DomEvent.on(this._element,'dblclick',function(a){this.fire('dblclick',a)},this),a.DomEvent.disableClickPropagation(this._element),this.enable()},_getProjectionCoef:function(){return(this.options.rangeMax-this.options.rangeMin)/(this._container.offsetWidth||this._container.style.width)},_update:function(){this.setPosition(a.DomUtil.getPosition(this._element).x)},_adjustX:function(a){var b=this._toValue(a)||this.getMinValue();return this._toX(this._adjustValue(b))},_adjustValue:function(a){return a=Math.max(this.getMinValue(),Math.min(this.getMaxValue(),a)),a=a-this.options.rangeMin,a=Math.round(a/this.options.step)*this.options.step,a=a+this.options.rangeMin,a=Math.round(a*100)/100,a},_toX:function(a){var b=(a-this.options.rangeMin)/this._getProjectionCoef();return b},_toValue:function(a){var b=a*this._getProjectionCoef()+this.options.rangeMin;return b},getMinValue:function(){return this.options.minValue||this.options.rangeMin},getMaxValue:function(){return this.options.maxValue||this.options.rangeMax},setStep:function(a){this.options.step=a,this._update()},setPosition:function(b){a.DomUtil.setPosition(this._element,a.point(this._adjustX(b),0)),this.fire('positionchanged')},getPosition:function(){return a.DomUtil.getPosition(this._element).x},setValue:function(a){this.setPosition(this._toX(a))},getValue:function(){return this._adjustValue(this._toValue(this.getPosition()))}}),a.Control.TimeDimension=a.Control.extend({options:{styleNS:'leaflet-control-timecontrol',position:'bottomleft',title:'Time Control',backwardButton:!0,forwardButton:!0,playButton:!0,playReverseButton:!1,loopButton:!1,displayDate:!0,displayAggregateTime:!0,timeSlider:!0,timeSliderDragUpdate:!1,limitSliders:!1,limitMinimumRange:5,speedSlider:!0,minSpeed:.1,maxSpeed:10,speedStep:.1,timeSteps:1,autoPlay:!1,formatDate:{formatMatcher:{year:'numeric',month:'numeric',day:'numeric'},locale:'en-US',separator:'/'},playerOptions:{transitionTime:1e3},timeZones:['UTC','Local']},initialize:function(b){a.Control.prototype.initialize.call(this,b),this._timeZoneIndex=0,this._timeDimension=this.options.timeDimension||null},onAdd:function(c){var b;return this._map=c,!this._timeDimension&&c.timeDimension&&(this._timeDimension=c.timeDimension),this._initPlayer(),b=a.DomUtil.create('div','leaflet-bar leaflet-bar-horizontal leaflet-bar-timecontrol'),this.options.backwardButton&&(this._buttonBackward=this._createButton('Backward',b)),this.options.playReverseButton&&(this._buttonPlayReversePause=this._createButton('Play Reverse',b)),this.options.playButton&&(this._buttonPlayPause=this._createButton('Play',b)),this.options.forwardButton&&(this._buttonForward=this._createButton('Forward',b)),this.options.loopButton&&(this._buttonLoop=this._createButton('Loop',b)),this.options.displayDate&&(this._displayDate=this._createButton('Date',b)),this.options.timeSlider&&(this._sliderTime=this._createSliderTime(this.options.styleNS+' timecontrol-slider timecontrol-dateslider',b)),this.options.speedSlider&&(this._sliderSpeed=this._createSliderSpeed(this.options.styleNS+' timecontrol-slider timecontrol-speed',b)),this.options.displayAggregateTime&&(this._displayAggregateTime=this._createToggle('Aggregate',b)),this._steps=this.options.timeSteps||1,this._timeDimension.on('timeload',this._update,this),this._timeDimension.on('timeload',this._onPlayerStateChange,this),this._timeDimension.on('timeloading',this._onTimeLoading,this),this._timeDimension.on('limitschanged availabletimeschanged',this._onTimeLimitsChanged,this),a.DomEvent.disableClickPropagation(b),b},addTo:function(){return a.Control.prototype.addTo.apply(this,arguments),this._onPlayerStateChange(),this._onTimeLimitsChanged(),this._update(),this},onRemove:function(){this._player.off('play stop running loopchange speedchange',this._onPlayerStateChange,this),this._player.off('waiting',this._onPlayerWaiting,this),this._timeDimension.off('timeload',this._update,this),this._timeDimension.off('timeload',this._onPlayerStateChange,this),this._timeDimension.off('timeloading',this._onTimeLoading,this),this._timeDimension.off('limitschanged availabletimeschanged',this._onTimeLimitsChanged,this)},_initPlayer:function(){this._player||(this.options.player?this._player=this.options.player:this._player=new a.TimeDimension.Player(this.options.playerOptions,this._timeDimension)),this.options.autoPlay&&this._player.start(this._steps),this._player.on('play stop running loopchange speedchange',this._onPlayerStateChange,this),this._player.on('waiting',this._onPlayerWaiting,this),this._onPlayerStateChange()},_onTimeLoading:function(b){b.time==this._timeDimension.getCurrentTime()&&this._displayDate&&a.DomUtil.addClass(this._displayDate,'loading')},_onTimeLimitsChanged:function(){var b=this._timeDimension.getLowerLimitIndex(),c=this._timeDimension.getUpperLimitIndex(),a=this._timeDimension.getAvailableTimes().length-1;this._limitKnobs&&(this._limitKnobs[0].options.rangeMax=a,this._limitKnobs[1].options.rangeMax=a,this._limitKnobs[0].setValue(b||0),this._limitKnobs[1].setValue(c||a)),this._sliderTime&&(this._sliderTime.options.rangeMax=a,this._sliderTime._update())},_onPlayerWaiting:function(b){this._buttonPlayPause&&this._player.getSteps()>0&&(a.DomUtil.addClass(this._buttonPlayPause,'loading'),this._buttonPlayPause.innerHTML=this._getDisplayLoadingText(b.available,b.buffer)),this._buttonPlayReversePause&&this._player.getSteps()<0&&(a.DomUtil.addClass(this._buttonPlayReversePause,'loading'),this._buttonPlayReversePause.innerHTML=this._getDisplayLoadingText(b.available,b.buffer))},_onPlayerStateChange:function(){if(this._buttonPlayPause&&(this._player.isPlaying()&&this._player.getSteps()>0?(a.DomUtil.addClass(this._buttonPlayPause,'pause'),a.DomUtil.removeClass(this._buttonPlayPause,'play')):(a.DomUtil.removeClass(this._buttonPlayPause,'pause'),a.DomUtil.addClass(this._buttonPlayPause,'play')),this._player.isWaiting()&&this._player.getSteps()>0?a.DomUtil.addClass(this._buttonPlayPause,'loading'):(this._buttonPlayPause.innerHTML='',a.DomUtil.removeClass(this._buttonPlayPause,'loading'))),this._buttonPlayReversePause&&(this._player.isPlaying()&&this._player.getSteps()<0?a.DomUtil.addClass(this._buttonPlayReversePause,'pause'):a.DomUtil.removeClass(this._buttonPlayReversePause,'pause'),this._player.isWaiting()&&this._player.getSteps()<0?a.DomUtil.addClass(this._buttonPlayReversePause,'loading'):(this._buttonPlayReversePause.innerHTML='',a.DomUtil.removeClass(this._buttonPlayReversePause,'loading'))),this._buttonLoop&&(this._player.isLooped()?a.DomUtil.addClass(this._buttonLoop,'looped'):a.DomUtil.removeClass(this._buttonLoop,'looped')),this._sliderSpeed&&!this._draggingSpeed){var b=this._player.getTransitionTime()||1e3;b=Math.round(1e4/b)/10,this._sliderSpeed.setValue(b)}},_update:function(){if(!this._timeDimension)return;if(this._timeDimension.getCurrentTimeIndex()>=0){var b=new Date(this._timeDimension.getCurrentTime());this._displayDate&&(a.DomUtil.removeClass(this._displayDate,'loading'),this._displayDate.innerHTML=this._getDisplayDateFormat(b)),this._sliderTime&&!this._slidingTimeSlider&&this._sliderTime.setValue(this._timeDimension.getCurrentTimeIndex())}else this._displayDate&&(this._displayDate.innerHTML=this._getDisplayNoTimeError())},_createToggle:function(c,d){var e=a.DomUtil.create('label','timecontrol-aggregate-toggle',d),b;return e.innerText=' '+c,e.htmlFor='label_'+c,b=a.DomUtil.create('input',this.options.styleNS+' timecontrol-'+c.toLowerCase(),d),b.type="checkbox",b.title=c,b.id='label_'+c,b.checked=this._timeDimension.getAggregateTime(),a.DomEvent.addListener(b,'change',a.DomEvent.stopPropagation).addListener(b,'change',a.DomEvent.preventDefault).addListener(b,'change',this['_button'+c.replace(/ /i,'')+'Clicked'],this),b},_createButton:function(c,d){var b=a.DomUtil.create('a',this.options.styleNS+' timecontrol-'+c.toLowerCase(),d);return b.href='#',b.title=c,a.DomEvent.addListener(b,'click',a.DomEvent.stopPropagation).addListener(b,'click',a.DomEvent.preventDefault).addListener(b,'click',this['_button'+c.replace(/ /i,'')+'Clicked'],this),b},_createSliderTime:function(h,g){var e,d,f,b,c;return e=a.DomUtil.create('div',h,g),d=a.DomUtil.create('div','slider',e),f=this._timeDimension.getAvailableTimes().length-1,this.options.limitSliders&&(c=this._limitKnobs=this._createLimitKnobs(d)),b=new a.UI.Knob(d,{className:'knob main',rangeMin:0,rangeMax:f}),b.on('dragend',function(a){var b=a.target.getValue();this._sliderTimeValueChanged(b),this._slidingTimeSlider=!1},this),b.on('drag',function(b){var a,c;this._slidingTimeSlider=!0,a=this._timeDimension.getAvailableTimes()[b.target.getValue()],a&&(c=new Date(a),this._displayDate&&(this._displayDate.innerHTML=this._getDisplayDateFormat(c)),this.options.timeSliderDragUpdate&&this._sliderTimeValueChanged(b.target.getValue()))},this),b.on('predrag',function(){var a,b;c&&(a=c[0].getPosition(),b=c[1].getPosition(),this._newPos.x<a&&(this._newPos.x=a),this._newPos.x>b&&(this._newPos.x=b))},b),a.DomEvent.on(d,'click',function(e){if(a.DomUtil.hasClass(e.target,'knob'))return;var g=e.touches&&e.touches.length===1?e.touches[0]:e,f=a.DomEvent.getMousePosition(g,d).x;c?c[0].getPosition()<=f&&f<=c[1].getPosition()&&(b.setPosition(f),this._sliderTimeValueChanged(b.getValue())):(b.setPosition(f),this._sliderTimeValueChanged(b.getValue()))},this),b.setPosition(0),b},_createLimitKnobs:function(e){var f,d,b,c;return a.DomUtil.addClass(e,'has-limits'),f=this._timeDimension.getAvailableTimes().length-1,d=a.DomUtil.create('div','range',e),b=new a.UI.Knob(e,{className:'knob lower',rangeMin:0,rangeMax:f}),c=new a.UI.Knob(e,{className:'knob upper',rangeMin:0,rangeMax:f}),a.DomUtil.setPosition(d,0),b.setPosition(0),c.setPosition(f),b.on('dragend',function(a){var b=a.target.getValue();this._sliderLimitsValueChanged(b,c.getValue())},this),c.on('dragend',function(a){var c=a.target.getValue();this._sliderLimitsValueChanged(b.getValue(),c)},this),b.on('drag positionchanged',function(){a.DomUtil.setPosition(d,a.point(b.getPosition(),0)),d.style.width=c.getPosition()-b.getPosition()+'px'},this),c.on('drag positionchanged',function(){d.style.width=c.getPosition()-b.getPosition()+'px'},this),c.on('predrag',function(){var a=b._toX(b.getValue()+this.options.limitMinimumRange);c._newPos.x<=a&&(c._newPos.x=a)},this),b.on('predrag',function(){var a=c._toX(c.getValue()-this.options.limitMinimumRange);b._newPos.x>=a&&(b._newPos.x=a)},this),b.on('dblclick',function(){this._timeDimension.setLowerLimitIndex(0)},this),c.on('dblclick',function(){this._timeDimension.setUpperLimitIndex(this._timeDimension.getAvailableTimes().length-1)},this),[b,c]},_createSliderSpeed:function(h,f){var e=a.DomUtil.create('div',h,f),c=a.DomUtil.create('span','speed',e),d=a.DomUtil.create('div','slider',e),g=Math.round(1e4/(this._player.getTransitionTime()||1e3))/10,b;return c.innerHTML=this._getDisplaySpeed(g),b=new a.UI.Knob(d,{step:this.options.speedStep,rangeMin:this.options.minSpeed,rangeMax:this.options.maxSpeed}),b.on('dragend',function(b){var a=b.target.getValue();this._draggingSpeed=!1,c.innerHTML=this._getDisplaySpeed(a),this._sliderSpeedValueChanged(a)},this),b.on('drag',function(a){this._draggingSpeed=!0,c.innerHTML=this._getDisplaySpeed(a.target.getValue())},this),b.on('positionchanged',function(a){c.innerHTML=this._getDisplaySpeed(a.target.getValue())},this),a.DomEvent.on(d,'click',function(e){if(e.target===b._element)return;var f=e.touches&&e.touches.length===1?e.touches[0]:e,g=a.DomEvent.getMousePosition(f,d).x;b.setPosition(g),c.innerHTML=this._getDisplaySpeed(b.getValue()),this._sliderSpeedValueChanged(b.getValue())},this),b},_buttonBackwardClicked:function(){this._timeDimension.previousTime(this._steps)},_buttonForwardClicked:function(){this._timeDimension.nextTime(this._steps)},_buttonLoopClicked:function(){this._player.setLooped(!this._player.isLooped())},_buttonPlayClicked:function(){this._player.isPlaying()?this._player.stop():this._player.start(this._steps)},_buttonPlayReverseClicked:function(){this._player.isPlaying()?this._player.stop():this._player.start(this._steps*-1)},_buttonDateClicked:function(){this._switchTimeZone()},_buttonAggregateClicked:function(){this._timeDimension.setAggregateTime(this._displayAggregateTime.checked)},_sliderTimeValueChanged:function(a){this._timeDimension.setCurrentTimeIndex(a)},_sliderLimitsValueChanged:function(a,b){this._timeDimension.setLowerLimitIndex(a),this._timeDimension.setUpperLimitIndex(b)},_sliderSpeedValueChanged:function(a){this._player.setTransitionTime(1e3/a)},_getCurrentTimeZone:function(){return this.options.timeZones[this._timeZoneIndex]},_switchTimeZone:function(){this._getCurrentTimeZone().toLowerCase()=='utc'&&a.DomUtil.removeClass(this._displayDate,'utc'),this._timeZoneIndex=(this._timeZoneIndex+1)%this.options.timeZones.length;var b=this._getCurrentTimeZone();b.toLowerCase()=='utc'?(a.DomUtil.addClass(this._displayDate,'utc'),this._displayDate.title='UTC Time'):b.toLowerCase()=='local'?this._displayDate.title='Local Time':this._displayDate.title=b,this._update()},_getDisplayDateFormat:function(a){if(this.options.formatDate)return this._getDisplayDateMasquerade(a);var b=this._getCurrentTimeZone();return b.toLowerCase()=='utc'?a.toISOString():b.toLowerCase()=='local'?a.toLocaleString():a.toLocaleString([],{timeZone:b,timeZoneName:"short"})},_getDisplayDateMasquerade:function(b){var a=new Date(b.getTime()+b.getTimezoneOffset()*6e4);return a=a.toLocaleDateString(this.options.formatDate.locale,this.options.formatDate.formatMatcher),this.options.formatDate.separator&&(a=a.split('/').join(this.options.formatDate.separator)),a},_getDisplaySpeed:function(a){return a+'fps'},_getDisplayLoadingText:function(a,b){return'<span>'+Math.floor(a/b*100)+'%</span>'},_getDisplayNoTimeError:function(){return'Time not available'}}),a.Map.addInitHook(function(){this.options.timeDimensionControl&&(this.timeDimensionControl=a.control.timeDimension(this.options.timeDimensionControlOptions||{}),this.addControl(this.timeDimensionControl))}),a.control.timeDimension=function(b){return new a.Control.TimeDimension(b)},a.TimeDimension},window)